<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="borrow">
<!-- 插入记录 -->
	<insert id="insertBorrow" parameterType="borrow">
		insert into tb_borrow
		(time,bookId,userId,status,operatorId)
		values
		(NOW(),#{bookId},#{userId},#{status},#{operatorId})
	</insert>
	<!-- 删除记录 -->
	<delete id="deleteApplication" parameterType="borrow">
		delete from tb_borrow WHERE id=#{id};
	</delete>
	
	<!-- 更新状态 ,完成借书-->
  <update id="updateStatus" parameterType="borrow">
  	update tb_borrow set status=#{status},operatorId=#{operatorId} where id=#{id}
  </update>
  <!-- 获取借阅信息 -->
  <select id="getBorrowList" parameterType="borrow" resultType="borrow">  
  	 SELECT r.*,u.name as userName,b.name as bookName, b.number,op.name as operatorName FROM tb_borrow r 
  	 LEFT JOIN tb_user u on r.userId=u.id 
  	 LEFT JOIN tb_book b on r.bookId=b.id 
  	 LEFT JOIN tb_user op on r.operatorId=op.id  	
  	 <where>
  	 		<if test="bookName!=''and bookName!=null">
				and b.name like "%${bookName}%"
			</if>
			<if test="userName!='' and userName!=null">
				and u.name like "%${userName}%"
			</if>
		  	<if test="number!='' and number!=null">
				and b.number like "%${number}%"
			</if>
			<if test="operatorName!='' and operatorName!=null">
				and op.name like "%${operatorName}%"
			</if>
  	 </where> 
			<if test="pageSize>0 and pageStart>-1">
				limit #{pageStart},#{pageSize}
			</if>
  </select>
  <!-- 获取总数量 -->
  <select id="getBorrowCount" parameterType="borrow" resultType="int">
  	 SELECT count(*) FROM tb_borrow r 
  	 LEFT JOIN tb_user u on r.userId=u.id 
  	 LEFT JOIN tb_book b on r.bookId=b.id 
  	 LEFT JOIN tb_user op on r.operatorId=op.id  
  	 	 <where>	
<if test="bookName!=''and bookName!=null">
		and b.name like "%${bookName}%"
	</if>
	<if test="userName!='' and userName!=null">
		and u.name like "%${userName}%"
	</if>
  	<if test="number!='' and number!=null">
		and b.number like "%${number}%"
	</if>
	<if test="operatorName!='' and operatorName!=null">
		and op.name like "%${operatorName}%"
	</if>
	</where>
  </select>
  
</mapper>